DATA PREPARATION AND UNDERSTANDING

--1.What is the total number of rows in each table in the database?
SELECT 'Customer' AS [TABLE], COUNT(customer_Id) AS [NO. OF ROWS]
FROM Customer
UNION ALL
SELECT 'Prod_cat_info' AS [TABLE], COUNT(prod_cat_code) AS [NO. OF ROWS]
FROM prod_cat_info
UNION ALL
SELECT 'Transactions' AS [TABLE], COUNT(transaction_id) AS [NO. OF ROWS]
FROM Transactions

--1.End

--2.Total number of transactions that have a return.
SELECT COUNT(transaction_id) [Transaction count with return]
FROM Transactions
WHERE Qty<0

--2.End

--3.onvert date variables into valid date format
SELECT CONVERT(DATE, DOB,103) AS [Formatted DOB]
FROM Customer
SELECT CONVERT(DATE, tran_date, 103) AS [Formatted date]
FROM Transactions


--3.End

--4.Time range of the transaction data available.
SELECT DATEDIFF(DAY, MIN(tran_date),MAX(tran_date)) AS 'Days_Count', 
DATEDIFF(MONTH, MIN(tran_date),MAX(tran_date)) AS 'Month_Count', 
DATEDIFF(YEAR, MIN(tran_date),MAX(tran_date)) AS 'Year_Count'
FROM Transactions

--4.End

--5.Which product category does the sub-category "DIY" belong to?
SELECT prod_cat AS [Product Category]
FROM prod_cat_info
where prod_subcat='DIY'

--5.End


--DATA ANALYSIS

--1.Which channel is most frequently used for transactions?
SELECT TOP 1 Store_type, COUNT(Store_type) AS COUNT
FROM Transactions
GROUP BY Store_type
ORDER BY COUNT DESC

--1.End

--2.What is the count of male and female customers?
SELECT GENDER, COUNT(Gender) AS [Count]
FROM Customer
WHERE GENDER IN('M', 'F')
GROUP BY Gender

--2.End

--3.Which city has maximum number of customers and how many?
SELECT TOP 1 city_code, COUNT(customer_Id) AS [Customer count]
FROM Customer
GROUP BY city_code
ORDER BY [Customer count] DESC

--3.End

--4.How many sub-categories are there under Books category?
SELECT COUNT( DISTINCT prod_subcat) [Subcategory_count]
FROM prod_cat_info
WHERE prod_cat='BOOKS'
GROUP BY prod_cat

--4.End

--5.What is the max quantity of products ever ordered?
SELECT MAX(Qty) AS [Max quantity]
FROM Transactions

--5.End

--6.What is the net total revenue generated in categories Electronics and Books?
SELECT  prod_cat, SUM(total_amt) [Net total revenue]
FROM prod_cat_info P, Transactions T
WHERE P.prod_cat_code= T.prod_cat_code and P.prod_sub_cat_code=T.prod_subcat_code
    AND prod_cat IN('ELECTRONICS','BOOKS')
GROUP BY prod_cat

--6.End

--7.How many customers have >10 transactions, excluding returns?
SELECT COUNT(cust_id) [No. of customers] 
FROM (
SELECT cust_id, COUNT(transaction_id) TRANS_COUNT
FROM  Transactions 
WHERE total_amt>0
GROUP BY cust_id 
HAVING COUNT(transaction_id)>10
) AS X

--7.End

--8.What is the combined revenue earned from Electronics and Clothing, from Flagship store? 
SELECT 'ELECTRONICS + CLOTHING' AS PROD_CATEGORY, SUM(Total_Revenue) AS [COMBINED REVENUE]
FROM(
SELECT T.prod_cat_code,SUM(total_amt) AS Total_Revenue
FROM Transactions T, prod_cat_info P
WHERE P.prod_cat_code= T.prod_cat_code AND P.prod_sub_cat_code=T.prod_subcat_code
      AND Store_type='FLAGSHIP STORE' 
      AND prod_cat IN('ELECTRONICS', 'CLOTHING')
GROUP BY T.prod_cat_code
) AS X

--8.End

--9.What is the total revenue generated by Male customers in Electronics category?
SELECT prod_subcat, [TOTAL REVENUE]
FROM prod_cat_info P
INNER JOIN (
SELECT prod_subcat_code,prod_cat_code,SUM(total_amt) [TOTAL REVENUE]
FROM Customer C, Transactions T
WHERE C.customer_Id= T.cust_id
AND Gender='M'
GROUP BY prod_cat_code,prod_subcat_code
) AS X
ON P.prod_cat_code=X.prod_cat_code AND P.prod_sub_cat_code=X.prod_subcat_code
WHERE prod_cat='ELECTRONICS'

--9.End
     
--10.What is the % of sales and returns by product sub category; display only top 5 sub categories based on sales.
SELECT prod_subcat, ROUND((SALES/(SELECT SUM(total_amt) 
FROM Transactions
 WHERE total_amt> 0))*100, 2) 'SALES%', 
 ROUND((ABS(RETURNS)/(SELECT ABS(SUM(total_amt) )
FROM Transactions
 WHERE total_amt< 0))*100,2) 'RETURNS%'
from(
SELECT TOP 5 prod_subcat, 
CAST(SUM(CASE WHEN total_amt>0 THEN total_amt ELSE 0 END) AS FLOAT) SALES, 
CAST(SUM(CASE WHEN total_amt<0 THEN total_amt ELSE 0 END) AS FLOAT) [RETURNS]
FROM Transactions T, prod_cat_info P
where P.prod_cat_code=T.prod_cat_code AND P.prod_sub_cat_code=T.prod_subcat_code
GROUP BY  prod_subcat
ORDER BY SALES DESC
) x

--10.End

--11.For all customers aged between 25 to 35 years find what is the net total revenue generated by them in last 30 days of transactions?
SELECT SUM(total_amt) [NET REVENUE]
FROM Customer C
INNER JOIN(
SELECT cust_id, total_amt
FROM Transactions
WHERE tran_date>= DATEADD(DAY,-30, (SELECT MAX(TRAN_DATE) FROM Transactions))
) X
ON C.customer_Id=X.cust_id
WHERE DATEDIFF(YEAR, CONVERT(DATE,DOB,103),(SELECT MAX(TRAN_DATE) FROM Transactions)) BETWEEN 25 AND 35

--11.End

--12.Which product category has seen max value of returns in last 3 months of transactions?
SELECT TOP 1 prod_cat
FROM(
SELECT prod_cat, SUM(ABS(total_amt)) [RETURNS VALUE]
FROM Transactions T, prod_cat_info P
WHERE T.prod_cat_code=P.prod_cat_code AND T.prod_subcat_code=P.prod_sub_cat_code
     AND total_amt<0
     AND tran_date>= DATEADD(MONTH,-3,(SELECT MAX(tran_date) FROM Transactions))
GROUP BY prod_cat) AS Y
ORDER BY [RETURNS VALUE] DESC

--12.End

--13.Which store type sells the max products;by value of sales amount and quantity sold?
SELECT TOP 1 Store_type
FROM(
SELECT Store_type, SUM(QTY) [QTY SOLD], SUM(total_amt) [SALES AMOUNT]
FROM Transactions
WHERE QTY>0 AND total_amt>0
GROUP BY Store_type) AS X
ORDER BY [SALES AMOUNT] DESC, [QTY SOLD] DESC

--13.End

--14.What are the categories for which average revenue is above overall average?
SELECT prod_cat, AVG(total_amt) [AVERAGE REVENUE]
FROM Transactions T, prod_cat_info P
WHERE T.prod_cat_code=P.prod_cat_code AND prod_sub_cat_code=prod_subcat_code
GROUP BY prod_cat
HAVING AVG(total_amt)>(SELECT AVG(total_amt) FROM Transactions)

--14.End

--15.Find the average and total revenue by each sub category for the categories which are among top 5 in terms of quantity sold.
SELECT prod_cat, prod_subcat, AVG(total_amt) [AVG REVENUE], SUM(total_amt) [TOTAL REVENUE]
FROM Transactions S, prod_cat_info Q
WHERE S.prod_subcat_code=Q.prod_sub_cat_code AND S.prod_cat_code=Q.prod_cat_code
    AND prod_cat IN(
    SELECT TOP 5 prod_cat
    FROM Transactions T, prod_cat_info P
    WHERE T.prod_subcat_code=P.prod_sub_cat_code AND T.prod_cat_code=P.prod_cat_code AND QTY>0
    GROUP BY prod_cat
    ORDER BY SUM(Qty) DESC
	)
GROUP BY prod_cat, prod_subcat
ORDER BY prod_cat

--15.End
